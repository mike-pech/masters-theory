# База

Фаервол помогает фильтровать трафик в сети касатльно правил

Есть три вида пакетов:
- Входящие (INPUT)
- Исходящие (OUTPUT)
- Проходящие (FORWARD)
# iptables

Это фреймворк для работы с `netfilter` — модулем ядра для фильтрации пакетов. Он уже deprecated, но всё ещё нужен на проде
## Концепты

Правило — базовая единица представляет собой действие с пакетом — ACCEPT, DROP (удалить), REJECT (отклонить), LOG (записать в лог), RETURN (отправить обратно во *встроенную* цепочку)

Цепочка — объединяют правила в последовательности. Если хотя бы одно правило срабатывает на пакет, то срабатывают они все. Есть три предопределённых по умолчанию на три вида пакетов. Можно определить свои цепочки — для декомпозиции правил (как функции в ЯП)

Таблица — группы цепочек под разные юзкейсы — Filter, NAT (маскарадинг), Mangle (изменение пакетов), Route (обработка сырых пакетов)
## Схема цепочек и роутинга пакетов

```
                               XXXXXXXXXXXXXXXXXX
                             XXX     Network    XXX
                               XXXXXXXXXXXXXXXXXX
                                       +
                                       |
                                       v
 +-------------+              +------------------+
 |table: filter| <---+        | table: nat       |
 |chain: INPUT |     |        | chain: PREROUTING|
 +-----+-------+     |        +--------+---------+
       |             |                 |
       v             |                 v
 [local process]     |           ****************          +--------------+
       |             +---------+ Routing decision +------> |table: filter |
       v                         ****************          |chain: FORWARD|
****************                                           +------+-------+
Routing decision                                                  |
****************                                                  |
       |                                                          |
       v                        ****************                  |
+-------------+       +------>  Routing decision  <---------------+
|table: nat   |       |         ****************
|chain: OUTPUT|       |               +
+-----+-------+       |               |
      |               |               v
      v               |      +-------------------+
+--------------+      |      | table: nat        |
|table: filter | +----+      | chain: POSTROUTING|
|chain: OUTPUT |             +--------+----------+
+--------------+                      |
                                      v
                               XXXXXXXXXXXXXXXXXX
                             XXX    Network     XXX
                               XXXXXXXXXXXXXXXXXX
```
## Синтаксис

`iptables` 
→ Осторожнее с пакетами на `lo` — пакеты, проходящие через `loopback` (`localhost`) не проходят через весь стек `netfilter`

`tcpdump` — пригождается для расшифровки пакетов, приходящих через машину

→ `-L` — List all — перечисляет все текущие правила

→ `iptables-save` выводит список правил на сохранение. Далее их можно перенаправить в конфиг — `>` или `>>` для добавления к конфигу

> [!INFO] `iptables` (как и `nftables`) не сохраняет правила между рантаймами системы
> Их нужно сохранять отедльно в конфигу

→ `-A` — вставить правило в конец цепочки 
    `iptables -A INPUT -p icmp -i eth0 -j DROP` — вставить в конец цепочки входящих пакетов по протоколу ICMP интерфейса eth0 — jump to правило DROP — таким образом мы сломали пинг на сервер
В то время как REJECT
    `iptables -A INPUT -p icmp -i eth0 -j DROP` — пакет не просто пропадает, а нам говорят, что `Destination port unreachable` — нас отклонили

→ `-I <n> <chain>` — вставить по порядку на позицию `<n>` в цепочку `<chain>`
## Сценарии
### Настройка DNAT

> DNAT — Destination Network Address Translation — меняет адрес исходящего пакета, если он выходит из внутренней сети

Для этого меняем адрес назначения пакета в прероутинге по протоколу TCP

```shell
# iptables -A PREROUTING -t nat -p tcp -j DNAT --dport <port> -j DNAT -to <address:port>
```
### Load Balancer

При помощи `-m statistic --mode random` можно случайно направлять пакеты по указанному адресу(-ам) с вероятностью `--probability`

```shel
# iptables -t nat -N BALANCER
# iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -j BALANCER
# iptables -t nat -A BALANCER -m statistic --mode random --probability 0.5 -j DNAT --to-destination <address:port> -p tcp
# iptables -t nat -A BALANCER -p tcp --dport 80 -j REDIRECT --to-port 80
```

### Rate Limiter

Для балансировки нагрузки достаточно ограничить запросы по порту в режиме `-m state` для новых пакетов `--state NEW`. В примере раз в минуту мы можем отправить пакет. Если мы превисим лимит, то нас отколнят

```shell
# iptables -A INPUT -m state --state NEW --dport 80 -m limit 1/min -j ACCEPT
# iptables -A INPUT -m state --state NEW -p tcp --dport 80 -j REJECT
```
# nftables

Более современный фреймворк, объединяющий в себе все протоколы, с которыми работали iptables, arptables, eptables, ip6tables и т.д.

Имеет схожие концепты с предшественником, синтаксис тоже схож
