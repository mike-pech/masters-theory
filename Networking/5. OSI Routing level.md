Третий уровень модели OSI отвечает за маршрутизаицю пакетов по сети — пакеты передаются из точки A в точку B (первый уровень), делятся на фреймы (второй уровень), теперь их нужно направить
# Настройка маршрутизации

![[Pasted image 20251004082921.png]]
Допустим что у нас есть два офиса с двумя отделами — нам нужно соединить два маршрутизатора кабелем

Но роутер 1 не знает, что существует роутер 2. Как донести обеим сетям соответствующие топологии?
## Смотрим линки

`$ ip link show` покажет конфигурацию на втором уровне
![[Pasted image 20251004083630.png]]

`$ ip addr show` покажет интерфейсы
![[Pasted image 20251004083710.png]]

Соединим интерфейсы при помощи `sudo ip link add veth0 type veth peer name veth1` — соединяем типом `veth` — Virtual Ethernet

Первая машина соединится и будет пинговать другую, но не наоборот — нужно обменяться маршрутами

Поднимем IP-туннель `sudo ip tunnel add tun0 mode ipip remote {удалённый сервер} local {локальный адрес}` на обоих машинах соответственно

Поднимем туннель `sudo ip link set tun0 up`

Но пакеты всё ещё не летят. Потому что он не знает про нашу новую сеть, отправляет в дефолт и пакеты там теряются
## Маршрутизация

Добавим маршрут `sudo ip route add {удалённый сервер} dev tun0`, но пакеты всё ещё не идут. Что делать?
### RIP

Используем RIP — простой, не самый оптимизированный, но действенный протокол динамической маршрутизации

Ставим `rff`, включаем его демон в конфиге и в системе

Протокол RIP сильно ограничен ввиду примитивности принципа работы, и поэтому применим только для небольших сетей «на скорую руку»
### OSPF

Протокол на основе алгоритма Дейкстры, которому не нужно составлять таблицы
### \*BGP 

В отсутствие хороших дистанто-векторных протоколов — RIP слишком примитивен и забивает сеть служебными сообщениями, EIGRP проприетарен и имеет проблемы с совместимостью

Также протокол нужен масштабируемый, с защитой от петель и выстроением топологии сети

2 конфигурации:
- EBGP — Внешний прокол для связи сегментов сети
- IBGP — Внутренний протокол для связи внутри сегмента сети

![[Pasted image 20251011083508.png]]

Изначально BGP не обнаруживает соседей, если они не прописаны в конфиге

Начальное состояние, когда ничего не происходит называется **Idle**. Как только будет настроен BGP на роутере, он начнет слушать TCP порт 179 — перейдет в состояние **Connect**, а когда пытается открыть сессию с другим роутером, то перейдет в состояние **Active**.  
  
После того, как сессия между роутерами установится, то происходит обмен Open сообщениями. Когда данное сообщение отправит первый роутер, то данное состояние будет называться **Open Sent**. А когда получит Open сообщение от другого роутера, то перейдет в состояние **Open Confirm**

> [!INFO] Если виснет, проверь фаервол

Рассмотрим более подробно сообщение Open:  
  
[![My Image](https://habrastorage.org/r/w1560/getpro/habr/post_images/d9d/231/607/d9d2316070de22049a24da6d86cecb2b.jpg)](https://i.imgur.com/iwXv3hW.jpg)  
В данном сообщение передается информация о самом протоколе BGP, который использует маршрутизатор. Обмениваясь Open сообщениями, роутеры сообщают друг другу информацию о своих настройках. Передаются следующие параметры:  

> - **Version**: this includes the BGP version that the router is using. The current version of BGP is version 4 which is described in RFC 4271. Two BGP routers will try to negotiate a compatible version, when there is a mismatch then there will be no BGP session.
> - **My AS**: this includes the AS number of the BGP router, the routers will have to agree on the AS number(s) and it also defines if they will be running iBGP or eBGP.
> - **Hold Time**: if BGP doesn’t receive any keepalive or update messages from the other side for the duration of the hold time then it will declare the other side ‘dead’ and it will tear down the BGP session. By default the hold time is set to 180 seconds on Cisco IOS routers, the keepalive message is sent every 60 seconds. Both routers have to agree on the hold time or there won’t be a BGP session.
> - **BGP Identifier**: this is the local BGP router ID which is elected just like OSPF does:  
>     - Use the router-ID that was configured manually with the bgp router-id command.
>     - Use the highest IP address on a loopback interface.
>     - Use the highest IP address on a physical interface.
> - **Optional Parameters**: here you will find some optional capabilities of the BGP router. This field has been added so that new features could be added to BGP without having to create a new version.Things you might find here are:  
>       
>     - support for MP-BGP (Multi Protocol BGP).
>     - support for Route Refresh.
>     - support for 4-octet AS numbers.

Для установления соседства необходимо выполнения следующих условий:  

- Номер версии. Нынешняя версия 4.
- Номер AS должен совпадать с тем, что вы настроили **neighbour 192.168.13.3 remote-as 10**.
- Router ID должен быть отличным от соседа.  

После отправки и получения Open сообщений, отношения соседства переходит в состояние **ESTABLISHED**. После этого уже маршрутизаторы могут обмениваться информацией о маршрутах и делают это при помощи **Update** сообщений.
### Атрибуты пути
  
[![My Image](https://habrastorage.org/r/w1560/getpro/habr/post_images/5e7/80b/ca0/5e780bca084e8f42dab14d03f62723b6.jpg)](https://i.imgur.com/MCZqzIn.jpg)  
Информация о маршруте состоит из аттрибутов пути (Path attributes).  
  
Атрибуты пути разделены на 4 категории:  
  
1. **Well-known mandatory** — все маршрутизаторы, работающие по протоколу BGP, должны распознавать эти атрибуты. Должны присутствовать во всех обновлениях (update).
2. **Well-known discretionary** — все маршрутизаторы, работающие по протоколу BGP, должны распознавать эти атрибуты. Могут присутствовать в обновлениях (update), но их присутствие не обязательно.
3. **Optional transitive** — могут не распознаваться всеми реализациями BGP. Если маршрутизатор не распознал атрибут, он помечает обновление как частичное (partial) и отправляет его дальше соседям, сохраняя не распознанный атрибут.
4. **Optional non-transitive** — могут не распознаваться всеми реализациями BGP. Если маршрутизатор не распознал атрибут, то атрибут игнорируется и при передаче соседям отбрасывается.
  
Примеры атрибутов BGP: 
- **Well-known mandatory**:  
    - Autonomous system path
    - Next-hop
    - Origin
- **Well-known discretionary**:  
    - Local preference
    - Atomic aggregate
- **Optional transitive**:  
    - Aggregator
    - Communities
- **Optional non-transitive**:  
    - Multi-exit discriminator (MED)
    - Originator ID
    - Cluster list

Атрибут Origin — указывает на то, каким образом был получен маршрут в обновлении. Возможные значения атрибута:  
- 0 — IGP: NLRI получена внутри исходной автономной системы;
- 1 — EGP: NLRI выучена по протоколу Exterior Gateway Protocol (EGP). Предшественник BGP, не используется
- 2 — Incomplete: NLRI была выучена каким-то другим образом
### Настройка BGP

Используем пакет `frr`

![[Pasted image 20251011085607.png]]
(В конфиге надо включить демон BGP лол)

Задаём IP адрес нашему роутеру
![[Pasted image 20251011085837.png]]

Поставив IP себя и соседей зададим `soft-reconfiguration` позволяющий реконфигурировать IP без необходимости рестарта системы

![[Pasted image 20251011090359.png]]

Не забываем сохранить

![[Pasted image 20251011090440.png]]

Делаем то же самое с соседом

![[Pasted image 20251011090924.png]]

![[Pasted image 20251011090938.png]]

![[Pasted image 20251011091010.png]]

> [!IMPORTANT] Не забываем активировать соседа при настройке BGP
> BGP надо знать, что к этому соседу можно подключаться

![[Pasted image 20251011091111.png]]
