# Проблемы старых моделей

Ранее разобранные модели Инмона и Кимбала пусть и предоставляют базу для аналитики Business Intelligence, но имеют свои недостатки, выявленные за время применения в Enterprise 
## Снежинка

- Данные не гарантированно историчны — историчность данных может быть нулевой; модель всего лишь теоритическая
- Данные строго привязаны к своему домену — продажи к продажам, завхоз к складу
- Сложность аггрегирования данных — ETL (Extract, Transform, Load) имеет много условий и медленнее работает
# Решение — модель Data Vault

Хранилище данных предложенное в 2000 году представляет собой надстройку к уже существующей схеме БД

В ней уже встроена историчность данных — факты попадают туда со всеми своими параметрами — продажа попадает со всеми данными о цене, доставке, дате и т.д.

Данные агрегируются без строгих ограничений по системе, из которой исходят, но с трассируемостью — с самых разных таблиц, но с явным указанием на источник.

Модель очень гибкая к разным задачам, но раздутая — очень много таблиц надстраивается. Таблицы всё ещё привязаны к Data Mart, в которых данные агрегируются для скорости доступа к данным. Поэтому благодаря своему удобству использования в аналитике, модель получила широчайшее распространение в Enterprise
## Структура

Система опирается на правило "a single version of the facts" — одна модель фактов, все данные за всё время в одном месте. Поэтому модель принимает все данные, без очистки тех данных, которые "не соответствуют бизнес-логике"

Модель устойчива к изменениям в бизнесе за счёт строгого разделения структурной информации от анализируемых атрибутов. Атрибуты могут удаляться или добавляться — в модели они всё равно будут учитываться — какие-то ранее неизвестные атрибуты станут NULL, какие-то более не учитываемые атрибуты будут NULL, но в данный момент времени для текущей структуры бизнеса набор атрибутов будет актуален.

![[Pasted image 20251020091332.png]]
### Ключевые компоненты
#### Хаб

Используется для хранения уникальных бизнес-ключей для интеграции разных источников в одну точку. Хранит только хэшированные бизнес-ключи с разных таблиц разных источников

Состоят из суррогатного ключа хаба, уникального хэшированного бизнес-ключа и метаданных об источнике бизнес-ключа. Также может хранить источник данных как след системы, их записавшей (опять же для трассируемости)

Составляют основу системы, к которой обращается аналитика за данными по соответствующим доменам. Так как хабы связаны линками, загрузка данных в них может производится параллельно, а сателиты вокруг хабов можно создавать неограниченно и также параллельно загружать

Пример:

| Поле          | Описание                                                                                                         |
| ------------- | ---------------------------------------------------------------------------------------------------------------- |
| H_CAR_ID      | Суррогатный ключ хаба на основе последовательности. Опционален                                                   |
| VEHICLE_ID_NR | Бизнес-ключ (а точнее его хэш), который описывает этот хаб. Может быть составным (не рекоммендуется). Обязателен |
| H_RSRC        | Record Source — источник записи. Обязателен                                                                      |
| LOAD_AUDIT_ID | Связка с таблицей аудита, в которой описаны данные о том, кто, когда и откуда вставил запись. Опциональна        |
#### Линк

Связывает разные хабы (или даже другие линки, но это усложняет параллельную загрузку) между собой по бизнес-ключам. Чаще в отношении "многие ко многим". 

При связи нескольких хабов мы можем выстроить, допустим, цепочку доставки путём ассоциации хаба клиентов из отдела клинетов и их адресов из соответствующего хаба отдела доставки

Линк также может связывать хабы с информацией, которую сложно поместить в какой-либо другой хаб. В таком случае мы можем подвязать к хабу таблицу заказов, имеющих только уникальный суррогатный номер заказа, нежели естественный бизнес-ключ

| Поле          | Описание                                                                                                  |
| ------------- | --------------------------------------------------------------------------------------------------------- |
| L_DRIVER_ID   | Суррогатный ключ из последовательности линков. Рекоммендуется                                             |
| H_CAR_ID      | Суррогатный ключ хаба автомобилей. Первая часть линка. Обязательна                                        |
| H_PERSON_ID   | Суррогатный ключ хаба водителей. Вторая часть линка. Обязательна                                          |
| L_RSRC        | Источник линка — кто и когда его создал. Обязателен                                                       |
| LOAD_AUDIT_ID | Связка с таблицей аудита, в которой описаны данные о том, кто, когда и откуда вставил запись. Опциональна |
#### Сателит

Хранит дескриптивные атрибуты и их историю взаимодействия с хабом или линком. Данные можно только добавить, поэтому он сохраняет версию самых релевантных атрибутов в строго определённый момент времени — данные атрибута и метаданные их историчности

В зависимости от применения, сателиты можно объединять или наоборот разъединять — допустим разъединить цену и цвет/размер товара, если цена меняется слишком быстро и независимо от других атрибутов

Пример:

| Поле                  | Описание                                                                                                                      |
| --------------------- | ----------------------------------------------------------------------------------------------------------------------------- |
| S_DRIVER_INSURANCE_ID | Суррогатный ключ сателита на основе последовательности. Опционален                                                            |
| L_DRIVER_ID           | Первичный ключ родителя сателита — хаба водителей. Обязателен                                                                 |
| S_SEQ_NR              | Суррогатный ключ, обеспечивающий уникальность данных, если они приходят в разные сателиты в одном хабе. Обязателен с условием |
| S_LDTS                | Дата начала загрузки. Обязательна                                                                                             |
| S_LEDTS               | Дата конца загрузки. Обязательна для процессов во времени                                                                     |
| IND_PRIMARY_DRIVER    | Данные атрибута сателита. Обязателен хотя бы один атрибут                                                                     |
| INSURANCE_COMPANY     | Данные атрибута сателита. Обязателен хотя бы один атрибут                                                                     |
| NR_OF_ACCIDENTS       | Данные атрибута сателита. Обязателен хотя бы один атрибут                                                                     |
| R_RISK_CATEGORY_CD    | Данные атрибута сателита. Обязателен хотя бы один атрибут                                                                     |
| S_RSRC                | Источник данных. Обязателен                                                                                                   |
| LOAD_AUDIT_ID         | Связка с таблицей аудита, в которой описаны данные о том, кто, когда и откуда вставил запись. Опциональна                     |
### Ключевые слои

Слой — понятие абстрактное и определяет теоритическую выборку данных в таблицах
#### Raw vault

Слой данных сформированный на основе источников с фокусом на трассируемость. Нужен для аудита данных 
#### Business vault

Слой, который применяет бизнес-логику и вспомогательные структуры (связующие таблицы) для удобного представления данных в Data Mart
## Архитектура данных Data Vault

Архитектура Data Vault 2.0 основана на трёх уровнях (см. рис.1) :
1.     **Область подготовки данных (слой Staging/ODS)**, которая собирает необработанные данные из источников
2.     **Уровень корпоративного хранилища данных (слой DDS)**, смоделированный как модель Data Vault 2.0
3.     **Уровень представления** (слой Data Marts & Information Marts) с аналитическими витринами в виде звёздных схем и других структур

![[Pasted image 20251020111544.png]]

Архитектура Data Vault 2.0 поддерживает разные способы загрузки данных:
- Пакетную загрузку из источников
- Загрузку в реальном времени через корпоративную шину данных (ESB) или сервисно-ориентированную архитектуру (SOA)

Также можно интегрировать неструктурированные NoSQL данные в Data Vault 2.0. Поскольку Data Vault 2.0 не зависит от платформ, NoSQL можно использовать на всех уровнях хранилища данных, включая подготовку данных, корпоративное хранилище и уровень предоставления информации
## Типичные ошибки
### Помещение данных в хаб

Хаб нужен только для хранения ключей данных — это обеспечивает скорость
### Не использовать хэш для ключей/использовать разные типы хэширования

Ключи разные по размеру и поэтому работать с ними будет последовательнее и удобнее, если свести их к одной длине хэшем
### Использование UPDATE/DELETE

Данные в Data Vault неизменяемы. Точка.
### Слишком большие сателиты

Это сильно замедляет работу схемы. Сателиты должны иметь только те данные, которые им необходимы.
### Дубликаты данных

Сами дубликаты безвредны, но есть нюанс — данные при агрегации (INSERTе в Data Vault) начнут расходится
### Ссылка на бизнес-ключи

Это помогает избегать коллизий по всей системе Data Vault — хэши (в меру) уникальны и более удобны в работе
### Не отделять сырые данные и данные для аналитики

