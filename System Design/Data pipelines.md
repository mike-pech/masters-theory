# Методы обработки задач

### Синхронная обработка

Обработка задач по очереди. По одной за раз. Сегодня уже редкая ситуация за счёт распространения технологий ансинхронной и параллельной обработки:
### Асинхронная обработка

Система неблокирующая. Обработчик один, но прыгает между задачами — чуть сделал одну, чуть сделал другую и третью
### Параллельная обработка

Полностью независимая обработка задач разными акторами. Обязательно должны быть развязаны, чтобы не зависеть друг от друга — сервисам нужны лишь связи для сообщений друг с другом, пока они работают независимо друг от друга

![[Pasted image 20251021082651.png]]
> Асинхронная/параллельная обработка не панацея — они делают систему более сложной, требуют больше ресурсов и включают оверхед на переключение задач
# Очереди

Включают некоторый системный буфер, который выравнивает нагрузку задач, храня задачи на обработку в себе
### Очередь сообщений

Служит для коммуникации между независимыми сервисами — передаёт события одного сервиса — пример Kafka
### Очередь задач

Служит для выгрузки ресурсоёмких задач и распределения большого количества задач между обработчиками путём прямого отправления задачи ему — пример RabbitMQ

| Аспект            | Очередь сообщений                          | Очередь задач                                      |
| ----------------- | ------------------------------------------ | -------------------------------------------------- |
| Цель              | Коммуникация сервисов                      | Выполнение задач                                   |
| Единица сообщения | Сообщение/событие                          | Задача                                             |
| Роль потребителя  | Легковесные сообщения, сложные потребители | Лёгкие потребители чисто для задач, сложный брокер |
| Хранение          | Часто длительное                           | До выполнения задачи                               |
| Сценарий          | Событийная архитектура                     | Обработка задач на фоне                            |
## Паттерны
### Point-to-point

Характерный паттерн для очередей задач. Сообщения доставляются от точки к точке, обрабатываются ровно одним потребителем, после чего удаляются. Доставка гарантируется

![[Pasted image 20251021083459.png]]
### Publisher-subscriber (Pub-Sub)

Характерный паттерн для очередей сообщений. Каждое сообщение попадает в общий пул, часто разбитый на разделы, под которые подписываются потребители и обрабатывают **подгрузку** этих сообщений уже у себя

![[Pasted image 20251021083518.png]]

# Модели обработки сообщений

### RabbitMQ

Классический брокер, реализующий модели Pub-Sub — сообщение идёт от продьюсера сообщения

![[Pasted image 20251021083908.png]]
### Apache Kafka

Строго говоря это распределённый лог, который просто хранит события и зачастую рассчитан на простое хранение сообщений, которые по-сложному обрабатывают потребители сообщений

![[Pasted image 20251021083924.png]]
### Cloud-native

Гибкое и масштабируемое решение, инкапсулирующее внутреннее устройство очереди и предоставляющая две модели — стек и очередь
# Data Pipeline
### Пакетная обработка

Данные в истории:
- Данные примерно однородны
- Идут чёткими интервалами
- Обрабатываются большими количествами

![[Pasted image 20251021084643.png]]

![[Pasted image 20251021084753.png]]

Хорошо подходит к отчётности в системах и прочей обработки огромных данных
### Потоковая обработка

Данные в движении:
- Данные неизвестного разного размера 
- Идут разными интервалами 
- Требуют быстрой обработки (низкая задержка)

Хорошо работает с Real-time задачами

![[Pasted image 20251021085100.png]]
# Устойчивость к сбоям

Три возможных точки гарантии доставки сообщений
## Не более одного раза

Отправил и забыл — проще, но сообщения могут потеряться — можно смириться с потерей данных
## Хотя бы один раз

![[Pasted image 20251021085447.png]]
## Ровно один раз

Очень сложный паттерн:
- Высокий оверхед
### Идемпотентный потребитель

Для создания надёжной (последовательной системы) потребитель должен быть идемпотентен — то есть работать с потоком одних и тех же сообщений так же как и с одним таким сообщением

![[Pasted image 20251021085708.png]]
Идемпотентность на основе работы с MessageID у потребителя

Также можно реализовать на основе бизнес логики (состояния в системе) или базы данных (`UNIQUE Messsage_ID`) 

> [!INFO] Некоторые операции идемпотентны по определению
> Напрмиер установка значения переменной